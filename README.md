# LevitatingInsect
Repository for PsychoPy Physical Integration

# FlyPy — Trigger → Cameras + Lights + Looming Stimulus (All-in-One GUI)

This app coordinates a **trigger** (hardware, simulated, or manual) to:
- Turn **lights** on/off (via Elegoo/Arduino over serial, or simulated)
- Record **two cameras** in sync to disk
- Show a **looming stimulus** (growing dot) on a selected monitor
- Log trial metadata (CSV) including file paths and timing markers

It ships with a **single-window GUI** (fixed 1920×1080) that exposes all settings in plain English, with tooltips.

---

## What’s New

- **Stimulus delay** control: set a delay between **recording start** and **stimulus onset**.
- **Display routing**: choose which **screen** shows the **Stimulus** and which screen shows the **GUI**.
- **Fullscreen/windowed** Stimulus: fullscreen pins to the chosen monitor; windowed can be dragged anywhere and **persists** across trials.
- **Manual “Trigger Once”** button: run a single trial immediately (great for testing without hardware).
- CSV log now includes: `stim_delay_s`, `stim_screen_index`, `stim_fullscreen`.

---

## Installation

### Windows (recommended)
```bat
Install.bat



FlyPy GUI Reference

This guide explains every control in the FlyPy GUI, what it changes internally, and which inputs/outputs are affected.

Layout: Single window (fixed 1920×1080). All text fields support word-wrap. Live camera previews appear on the lower half; settings are at the top.

Quick Map (Control → Code → Effects)

Start / Stop / Apply Settings

Code: MainApp.start_loop(), MainApp.stop_loop(), MainApp.apply_from_gui()

Effects: Starts/stops the trigger loop; applies new values from the GUI to the running system.

General settings

Simulated trigger interval → Config.sim_trigger_interval → Used by HardwareBridge.check_trigger() when Simulation is ON.

Output folder → Config.output_root → All videos/logs saved here (<root>/<YYYYMMDD>/…).

Video codec (FOURCC) → Config.fourcc → Used by CameraRecorder.record_clip(); selects encoder.

Recording duration per trigger → Config.record_duration_s → Length of video capture after a trigger.

Looming stimulus

Duration → Config.stim_duration_s → How long the dot animates during a trial.

Start radius / Final radius → Config.stim_r0_px / Config.stim_r1_px → Pixel size of the dot (grows r0→r1).

Background shade (0–1) → Config.stim_bg_grey → Stimulus background (1=white, 0=black).

Camera N — preview & frame rate

Device index → CameraRecorder.set_index() + Config.camN_index → Which camera OpenCV opens.

Target recording FPS → CameraRecorder.set_target_fps() + Config.camN_target_fps → Intended FPS for recorded files.

Info labels (read-only): driver-reported FPS, GUI-measured preview FPS, recording target FPS.

Top Bar Controls
Start

What it does: Begins the background trigger loop. The Status changes to “Watching for triggers…”.

Code path: MainApp.start_loop() → starts a thread that runs MainApp.loop().

Inputs used: All current values from General, Stimulus, and Camera panels (via Apply Settings automatically invoked by Start).

Outputs affected: Starts producing videos and CSV logs on every trigger.

Stop

What it does: Stops the trigger loop and returns to idle. Safe to quit afterward.

Code path: MainApp.stop_loop().

Outputs affected: No new trials will run until you press Start again.

Apply Settings

What it does: Copies widget values into the active Config and camera objects.

Code path: MainApp.apply_from_gui().

When to use: After changing any field. (Start also applies automatically.)

General Settings
Simulation mode (label)

What it shows: Whether Simulation Mode is ON or OFF. Chosen at app startup via Yes/No dialog.

Code fields: Config.simulation_mode

Impacts: If ON, triggers are generated by a timer; if OFF, the app listens to Elegoo UNO over USB.

Interval between simulated triggers (seconds)

Widget: QDoubleSpinBox

Code fields: Config.sim_trigger_interval

Used by: HardwareBridge.check_trigger() (simulation path)

Impacts: How often a simulated trigger fires (no hardware required).
Larger interval reduces CPU usage.

Output folder for all trials

Widget: QLineEdit + Browse…

Code fields: Config.output_root

Used by: TrialRunner.run_trial() and logger setup

Impacts (outputs):

Creates <OutputRoot>/<YYYYMMDD>/

Writes *_cam0.mp4 and *_cam1.mp4 (or .avi) files inside the dated folder.

Updates/creates trials_log.csv in <OutputRoot>/.

Video codec (FOURCC code)

Widget: QComboBox (choices: mp4v, avc1, XVID)

Code fields: Config.fourcc

Used by: CameraRecorder.record_clip() (VideoWriter)

Impacts (outputs):

Encoder and container selection:

mp4v → .mp4 (very compatible)

avc1 (H.264) → .mp4 (smaller files if supported by your system)

XVID → .avi

If a codec isn’t supported by your system, OpenCV may fail to open the writer.

Recording duration per trigger (seconds)

Widget: QDoubleSpinBox

Code fields: Config.record_duration_s

Used by: CameraRecorder.record_clip() (stop time)

Impacts (outputs): Video length per trial. Longer clips → larger files.

Looming Stimulus (growing dot)
Stimulus display duration (seconds)

Widget: QDoubleSpinBox

Code fields: Config.stim_duration_s

Used by: LoomingStim.run()

Impacts: How long the dot grows while cameras are recording.

Starting dot radius (pixels)

Widget: QSpinBox

Code fields: Config.stim_r0_px

Used by: LoomingStim.run()

Impacts: Initial dot size (in pixels).

Final dot radius (pixels)

Widget: QSpinBox

Code fields: Config.stim_r1_px

Used by: LoomingStim.run()

Impacts: Final dot size (in pixels) at the end of the stimulus.

Stimulus background shade (0 = black, 1 = white)

Widget: QDoubleSpinBox

Code fields: Config.stim_bg_grey (default 1.0 = white)

Used by: LoomingStim.run()

PsychoPy path: passes as window color

OpenCV fallback: fills frame with shade 0–255

Impacts: The background behind the dot. (The dot itself is black.)

Camera Panels (Cam 0 and Cam 1)

Each panel shows a live preview (bottom overlay shows the OpenCV Index N) plus controls and read-only FPS readouts.

Which camera to use (OpenCV device index)

Widget: QSpinBox (0–15)

Code path: CameraRecorder.set_index(index) → updates Config.camN_index

Used by: OpenCV VideoCapture(index) for preview and recording

Impacts (input): Selects the physical camera. If unavailable, the app falls back to a synthetic feed (clearly labeled).

Tip: Change this if the preview shows the wrong device; click Apply Settings.

Target recording frame rate (fps)

Widget: QSpinBox (1–10,000; typable; default 60)

Code path: CameraRecorder.set_target_fps(fps) → updates Config.camN_target_fps

Used by: Writer in CameraRecorder.record_clip() and a hint to the capture driver (CAP_PROP_FPS)

Impacts (output): Intended frames per second in the recorded file.
Note: Actual FPS depends on camera capability/resolution/USB bandwidth. Ultra-high values (kHz) require specialized hardware.

Driver-reported frame rate (may be 0 on some webcams)

Widget: QLabel (read-only)

Code path: CameraRecorder.reported_fps()

Meaning: Reads CAP_PROP_FPS from the driver. Many webcams return 0 or an inaccurate value here.

Measured preview frame rate (GUI)

Widget: QLabel (read-only)

Code path: CameraRecorder.measured_preview_fps()

Meaning: FPS measured from the Preview update timer, not the recording file.

Recording target frame rate (intended)

Widget: QLabel (read-only)

Code path: CameraRecorder.target_fps

Meaning: Echoes the target FPS you set, for clarity.

Status (bottom label)

Widget: QLabel (read-only)

Shows:

Idle / Waiting / Idle

Watching for triggers…

Trial running (preview paused)

Trial finished.

Stopped.

Error — <message>

Code path: Updated by MainApp.update_previews(), MainApp.loop(), MainApp.stop_loop()

What Happens On Each Trigger

Sync markers sent to Elegoo (if connected): START, then later STIM, then END.

Code: HardwareBridge.mark_start(), mark_stim(), mark_end()

Lights ON via Elegoo command (or simulated log).

Code: HardwareBridge.activate_lights() → light_on()

Both cameras record in parallel for Recording duration per trigger.

Code: CameraRecorder.record_clip() (each camera)

Looming stimulus runs for Stimulus display duration.

Code: LoomingStim.run() (PsychoPy if available; otherwise OpenCV window)

CSV log is appended with trial metadata and file paths.

Code: TrialRunner.run_trial() → writes to trials_log.csv

Outputs (Files & Folders)

Video files (per trial):
<OutputRoot>/<YYYYMMDD>/<timestamp>_trial####_cam0(.mp4|.avi)
<OutputRoot>/<YYYYMMDD>/<timestamp>_trial####_cam1(.mp4|.avi)

Container/codec chosen by Video codec (FOURCC).

CSV log:
<OutputRoot>/trials_log.csv (appends rows with trial index, timestamp, file paths, durations, target FPS).

Inputs (Triggers & Hardware)

Simulation Mode ON: Triggers generated every Interval between simulated triggers seconds.

Simulation Mode OFF: Triggers read from Elegoo UNO over USB serial: a line with T.

Auto-detects CH340 (VID_1A86 / PID_7523) ports when possible.

Commands sent to Elegoo: START, STIM, END, LIGHT ON/OFF, PULSE n.

Tips & Troubleshooting

No camera preview:

Ensure the device index matches the camera. Synthetic preview indicates an unavailable index.

Codec not working:

Try switching FOURCC (e.g., mp4v for compatibility). Some systems need additional codecs.

FPS not achieved:

Hardware and USB bandwidth limit real FPS. Lower resolution or target FPS if needed.

Stimulus on the wrong screen:

PsychoPy uses a resizable window (not full screen) by default; move it and close after the trial if desired.

Behind the Scenes (per control)
GUI Element	Config / Object	Read by (Runtime)	Notes
Interval between simulated triggers	Config.sim_trigger_interval	HardwareBridge.check_trigger()	Only used in Simulation Mode
Output folder	Config.output_root	TrialRunner.run_trial()	Creates date folder; writes videos & CSV
Video codec (FOURCC)	Config.fourcc	CameraRecorder.record_clip()	Chooses encoder & container
Record duration	Config.record_duration_s	CameraRecorder.record_clip()	Capture length
Stimulus duration	Config.stim_duration_s	LoomingStim.run()	Dot growth time
Start/Final radius	Config.stim_r0_px / stim_r1_px	LoomingStim.run()	Pixel radii
Background shade	Config.stim_bg_grey	LoomingStim.run()	1.0 = white (default)
Cam index (0/1)	CameraRecorder.set_index() → Config.camN_index	OpenCV VideoCapture	Selects device or synthetic
Target FPS (0/1)	CameraRecorder.set_target_fps() → Config.camN_target_fps	VideoWriter & capture hint	Intended FPS (hardware-limited)
Driver FPS label	(read) CameraRecorder.reported_fps()	—	From CAP_PROP_FPS; can be 0/incorrect
Measured preview FPS	(read) CameraRecorder.measured_preview_fps()	—	GUI timer based
Recording target FPS label	(read) CameraRecorder.target_fps	—	Mirror of target setting
Safe Shutdown

Press Stop then close the window.

The app also registers cleanup handlers to close cameras, serial ports, and the CSV log gracefully.

This documentation matches the current FlyPy GUI and code structure (MainApp, SettingsGUI, TrialRunner, CameraRecorder, HardwareBridge, LoomingStim).
